'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.decoders = exports.encoders = exports.opcodes = undefined;

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

//http://stackoverflow.com/questions/8609289/convert-a-binary-nodejs-buffer-to-javascript-arraybuffer
// converts a nodejs Buffer to ArrayBuffer
// export function bufferToArrayBuffer(buffer) {
//   const ab = new ArrayBuffer(buffer.length);
//   const view = new Uint8Array(ab);

//   for (let i = 0; i < buffer.length; ++i)
//     view[i] = buffer[i];

//   return ab;
// }

// export function arrayBufferToBuffer(arrayBuffer) {
//   const buffer = new Buffer(arrayBuffer.byteLength);
//   const view = new Uint8Array(arrayBuffer);

//   for (let i = 0; i < buffer.length; ++i)
//     buffer[i] = view[i];

//   return buffer;
// }

// http://updates.html5rocks.com/2012/06/How-to-convert-ArrayBuffer-to-and-from-String
function Uint16Array2json(arr) {
  var str = String.fromCharCode.apply(null, arr);
  return JSON.parse(str.replace(/\u0000/g, ''));
}

function json2Uint16Array(json) {
  var str = (0, _stringify2.default)(json);
  var buffer = new ArrayBuffer(str.length * 2); // 2 bytes for each char
  var bufferView = new Uint16Array(buffer);

  for (var i = 0, l = str.length; i < l; i++) {
    bufferView[i] = str.charCodeAt(i);
  }return bufferView;
}

var opcodes = exports.opcodes = {
  INIT_MODULE_REQ: 10,
  INIT_MODULE_ACK: 11,
  PROCESS_STREAM_PARAMS: 12,
  RESET_STREAM: 13,
  FINALIZE_STREAM: 14,
  PROCESS_FRAME: 15

  //
};var encoders = exports.encoders = {
  opcode: function opcode(name) {
    var opcode = opcodes[name];
    var buffer = new Uint16Array(1);
    buffer[0] = opcode;

    return buffer;
  },

  // `opcode`    2 bytes (Uint16) |
  initModuleReq: function initModuleReq() {
    var payload = encoders.opcode('INIT_MODULE_REQ');
    return payload.buffer;
  },
  // `opcode`    2 bytes (Uint16) |
  initModuleAck: function initModuleAck() {
    var payload = encoders.opcode('INIT_MODULE_ACK');
    return payload.buffer;
  },
  // `opcode`    2 bytes (Uint16) |
  // `streamParams`  n bytes (Uint16)
  streamParams: function streamParams(_streamParams) {
    var opcode = encoders.opcode('PROCESS_STREAM_PARAMS');
    var streamParamsBuffer = json2Uint16Array(_streamParams);

    var payload = new Uint16Array(1 + streamParamsBuffer.length);
    payload.set(opcode, 0);
    payload.set(streamParamsBuffer, 1);

    return payload.buffer;
  },
  // `opcode`    2 bytes (Uint16) |
  resetStream: function resetStream() {
    var payload = encoders.opcode('RESET_STREAM');
    return payload.buffer;
  },
  // `opcode`    2 bytes (Uint16) |
  // `endTime`   8 bytes (Float64)
  finalizeStream: function finalizeStream(endTime) {
    var opcode = encoders.opcode('RESET_STREAM');

    var endTimeBuffer = new Float64Array(1);
    endTimeBuffer[0] = endTime;

    var payload = new Uint16Array(1 + 4);
    payload.set(opcode, 0);
    payload.set(new Uint16Array(endTimeBuffer.buffer), 1);

    return payload.buffer;
  },
  // `opcode`    2 bytes (Uint16) |
  // `time`      8 bytes (Float64) |
  // `data`      frameSize * 4 (Float32) |
  // `metadata`  n bytes (Uint16)
  processFrame: function processFrame(frame, frameSize) {
    var opcode = encoders.opcode('PROCESS_FRAME');

    var time = new Float64Array(1);
    time[0] = frame.time;

    var data = new Float32Array(frameSize);
    for (var i = 0; i < frameSize; i++) {
      data[i] = frame.data[i];
    }var metadata = json2Uint16Array(frame.metadata);

    var length = 1 + 4 + 2 * frameSize + metadata.length;
    var payload = new Uint16Array(length);
    payload.set(opcode, 0);
    payload.set(new Uint16Array(time.buffer), 1);
    payload.set(new Uint16Array(data.buffer), 1 + 4);
    payload.set(metadata, 1 + 4 + 2 * frameSize);

    return payload.buffer;
  }
};

var decoders = exports.decoders = {
  opcode: function opcode(arrayBuffer) {
    return new Uint16Array(arrayBuffer)[0];
  },

  // `opcode`    2 bytes (Uint16) |
  // `streamParams`  n bytes (Uint16)
  streamParams: function streamParams(arrayBuffer) {
    var payload = new Uint16Array(arrayBuffer.slice(2));
    var prevStreamParams = Uint16Array2json(payload);
    return prevStreamParams;
  },

  // `opcode`    2 bytes (Uint16) |
  // `endTime`   8 bytes (Float64)
  finalizeStream: function finalizeStream(arrayBuffer) {
    return new Float64Array(arrayBuffer.slice(2))[0];
  },

  // `opcode`    2 bytes (Uint16) |
  // `time`      8 bytes (Float64) |
  // `data`      frameSize * 4 (Float32) |
  // `metadata`  n bytes (Uint16)
  processFrame: function processFrame(arrayBuffer, frameSize) {
    // 1 * 8 bytes
    var timeStart = 2;
    var timeEnd = timeStart + 8;
    var time = new Float64Array(arrayBuffer.slice(timeStart, timeEnd))[0];
    // frameSize * 4 bytes
    var dataStart = timeEnd;
    var dataEnd = dataStart + 4 * frameSize;
    var data = new Float32Array(arrayBuffer.slice(dataStart, dataEnd));
    // rest of payload
    var metaStart = dataEnd;
    var metaBuffer = new Uint16Array(arrayBuffer.slice(metaStart));
    var metadata = Uint16Array2json(metaBuffer);

    return { time: time, data: data, metadata: metadata };
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndzVXRpbHMuanMiXSwibmFtZXMiOlsiVWludDE2QXJyYXkyanNvbiIsImFyciIsInN0ciIsIlN0cmluZyIsImZyb21DaGFyQ29kZSIsImFwcGx5IiwiSlNPTiIsInBhcnNlIiwicmVwbGFjZSIsImpzb24yVWludDE2QXJyYXkiLCJqc29uIiwiYnVmZmVyIiwiQXJyYXlCdWZmZXIiLCJsZW5ndGgiLCJidWZmZXJWaWV3IiwiVWludDE2QXJyYXkiLCJpIiwibCIsImNoYXJDb2RlQXQiLCJvcGNvZGVzIiwiSU5JVF9NT0RVTEVfUkVRIiwiSU5JVF9NT0RVTEVfQUNLIiwiUFJPQ0VTU19TVFJFQU1fUEFSQU1TIiwiUkVTRVRfU1RSRUFNIiwiRklOQUxJWkVfU1RSRUFNIiwiUFJPQ0VTU19GUkFNRSIsImVuY29kZXJzIiwib3Bjb2RlIiwibmFtZSIsImluaXRNb2R1bGVSZXEiLCJwYXlsb2FkIiwiaW5pdE1vZHVsZUFjayIsInN0cmVhbVBhcmFtcyIsInN0cmVhbVBhcmFtc0J1ZmZlciIsInNldCIsInJlc2V0U3RyZWFtIiwiZmluYWxpemVTdHJlYW0iLCJlbmRUaW1lIiwiZW5kVGltZUJ1ZmZlciIsIkZsb2F0NjRBcnJheSIsInByb2Nlc3NGcmFtZSIsImZyYW1lIiwiZnJhbWVTaXplIiwidGltZSIsImRhdGEiLCJGbG9hdDMyQXJyYXkiLCJtZXRhZGF0YSIsImRlY29kZXJzIiwiYXJyYXlCdWZmZXIiLCJzbGljZSIsInByZXZTdHJlYW1QYXJhbXMiLCJ0aW1lU3RhcnQiLCJ0aW1lRW5kIiwiZGF0YVN0YXJ0IiwiZGF0YUVuZCIsIm1ldGFTdGFydCIsIm1ldGFCdWZmZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0EsU0FBU0EsZ0JBQVQsQ0FBMEJDLEdBQTFCLEVBQStCO0FBQzdCLE1B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Y0Usa0JBQWQsRUFBUDtBQUNIO0FBbkNxQixDQUFqQiIsImZpbGUiOiJ3c1V0aWxzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy9odHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzg2MDkyODkvY29udmVydC1hLWJpbmFyeS1ub2RlanMtYnVmZmVyLXRvLWphdmFzY3JpcHQtYXJyYXlidWZmZXJcbi8vIGNvbnZlcnRzIGEgbm9kZWpzIEJ1ZmZlciB0byBBcnJheUJ1ZmZlclxuLy8gZXhwb3J0IGZ1bmN0aW9uIGJ1ZmZlclRvQXJyYXlCdWZmZXIoYnVmZmVyKSB7XG4vLyAgIGNvbnN0IGFiID0gbmV3IEFycmF5QnVmZmVyKGJ1ZmZlci5sZW5ndGgpO1xuLy8gICBjb25zdCB2aWV3ID0gbmV3IFVpbnQ4QXJyYXkoYWIpO1xuXG4vLyAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnVmZmVyLmxlbmd0aDsgKytpKVxuLy8gICAgIHZpZXdbaV0gPSBidWZmZXJbaV07XG5cbi8vICAgcmV0dXJuIGFiO1xuLy8gfVxuXG4vLyBleHBvcnQgZnVuY3Rpb24gYXJyYXlCdWZmZXJUb0J1ZmZlcihhcnJheUJ1ZmZlcikge1xuLy8gICBjb25zdCBidWZmZXIgPSBuZXcgQnVmZmVyKGFycmF5QnVmZmVyLmJ5dGVMZW5ndGgpO1xuLy8gICBjb25zdCB2aWV3ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWZmZXIpO1xuXG4vLyAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnVmZmVyLmxlbmd0aDsgKytpKVxuLy8gICAgIGJ1ZmZlcltpXSA9IHZpZXdbaV07XG5cbi8vICAgcmV0dXJuIGJ1ZmZlcjtcbi8vIH1cblxuLy8gaHR0cDovL3VwZGF0ZXMuaHRtbDVyb2Nrcy5jb20vMjAxMi8wNi9Ib3ctdG8tY29udmVydC1BcnJheUJ1ZmZlci10by1hbmQtZnJvbS1TdHJpbmdcbmZ1bmN0aW9uIFVpbnQxNkFycmF5Mmpzb24oYXJyKSB7XG4gIGNvbnN0IHN0ciA9IFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkobnVsbCwgYXJyKTtcbiAgcmV0dXJuIEpTT04ucGFyc2Uoc3RyLnJlcGxhY2UoL1xcdTAwMDAvZywgJycpKVxufVxuXG5mdW5jdGlvbiBqc29uMlVpbnQxNkFycmF5KGpzb24pIHtcbiAgY29uc3Qgc3RyID0gSlNPTi5zdHJpbmdpZnkoanNvbik7XG4gIGNvbnN0IGJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcihzdHIubGVuZ3RoICogMik7IC8vIDIgYnl0ZXMgZm9yIGVhY2ggY2hhclxuICBjb25zdCBidWZmZXJWaWV3ID0gbmV3IFVpbnQxNkFycmF5KGJ1ZmZlcik7XG5cbiAgZm9yIChsZXQgaSA9IDAsIGwgPSBzdHIubGVuZ3RoOyBpIDwgbDsgaSsrKVxuICAgIGJ1ZmZlclZpZXdbaV0gPSBzdHIuY2hhckNvZGVBdChpKTtcblxuICByZXR1cm4gYnVmZmVyVmlldztcbn1cblxuXG5leHBvcnQgY29uc3Qgb3Bjb2RlcyA9IHtcbiAgSU5JVF9NT0RVTEVfUkVROiAxMCxcbiAgSU5JVF9NT0RVTEVfQUNLOiAxMSxcbiAgUFJPQ0VTU19TVFJFQU1fUEFSQU1TOiAxMixcbiAgUkVTRVRfU1RSRUFNOiAxMyxcbiAgRklOQUxJWkVfU1RSRUFNOiAxNCxcbiAgUFJPQ0VTU19GUkFNRTogMTVcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBlbmNvZGVycyA9IHtcbiAgb3Bjb2RlKG5hbWUpIHtcbiAgICBjb25zdCBvcGNvZGUgPSBvcGNvZGVzW25hbWVdO1xuICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBVaW50MTZBcnJheSgxKTtcbiAgICBidWZmZXJbMF0gPSBvcGNvZGU7XG5cbiAgICByZXR1cm4gYnVmZmVyO1xuICB9LFxuICAvLyBgb3Bjb2RlYCAgICAyIGJ5dGVzIChVaW50MTYpIHxcbiAgaW5pdE1vZHVsZVJlcTogZnVuY3Rpb24oKSB7XG4gICAgY29uc3QgcGF5bG9hZCA9IGVuY29kZXJzLm9wY29kZSgnSU5JVF9NT0RVTEVfUkVRJyk7XG4gICAgcmV0dXJuIHBheWxvYWQuYnVmZmVyO1xuICB9LFxuICAvLyBgb3Bjb2RlYCAgICAyIGJ5dGVzIChVaW50MTYpIHxcbiAgaW5pdE1vZHVsZUFjazogZnVuY3Rpb24oKSB7XG4gICAgY29uc3QgcGF5bG9hZCA9IGVuY29kZXJzLm9wY29kZSgnSU5JVF9NT0RVTEVfQUNLJyk7XG4gICAgcmV0dXJuIHBheWxvYWQuYnVmZmVyO1xuICB9LFxuICAvLyBgb3Bjb2RlYCAgICAyIGJ5dGVzIChVaW50MTYpIHxcbiAgLy8gYHN0cmVhbVBhcmFtc2AgIG4gYnl0ZXMgKFVpbnQxNilcbiAgc3RyZWFtUGFyYW1zOiBmdW5jdGlvbihzdHJlYW1QYXJhbXMpIHtcbiAgICBjb25zdCBvcGNvZGUgPSBlbmNvZGVycy5vcGNvZGUoJ1BST0NFU1NfU1RSRUFNX1BBUkFNUycpO1xuICAgIGNvbnN0IHN0cmVhbVBhcmFtc0J1ZmZlciA9IGpzb24yVWludDE2QXJyYXkoc3RyZWFtUGFyYW1zKTtcblxuICAgIGNvbnN0IHBheWxvYWQgPSBuZXcgVWludDE2QXJyYXkoMSArIHN0cmVhbVBhcmFtc0J1ZmZlci5sZW5ndGgpO1xuICAgIHBheWxvYWQuc2V0KG9wY29kZSwgMCk7XG4gICAgcGF5bG9hZC5zZXQoc3RyZWFtUGFyYW1zQnVmZmVyLCAxKTtcblxuICAgIHJldHVybiBwYXlsb2FkLmJ1ZmZlcjtcbiAgfSxcbiAgLy8gYG9wY29kZWAgICAgMiBieXRlcyAoVWludDE2KSB8XG4gIHJlc2V0U3RyZWFtOiBmdW5jdGlvbigpIHtcbiAgICBjb25zdCBwYXlsb2FkID0gZW5jb2RlcnMub3Bjb2RlKCdSRVNFVF9TVFJFQU0nKTtcbiAgICByZXR1cm4gcGF5bG9hZC5idWZmZXI7XG4gIH0sXG4gIC8vIGBvcGNvZGVgICAgIDIgYnl0ZXMgKFVpbnQxNikgfFxuICAvLyBgZW5kVGltZWAgICA4IGJ5dGVzIChGbG9hdDY0KVxuICBmaW5hbGl6ZVN0cmVhbTogZnVuY3Rpb24oZW5kVGltZSkge1xuICAgIGNvbnN0IG9wY29kZSA9IGVuY29kZXJzLm9wY29kZSgnUkVTRVRfU1RSRUFNJyk7XG5cbiAgICBjb25zdCBlbmRUaW1lQnVmZmVyID0gbmV3IEZsb2F0NjRBcnJheSgxKTtcbiAgICBlbmRUaW1lQnVmZmVyWzBdID0gZW5kVGltZTtcblxuICAgIGNvbnN0IHBheWxvYWQgPSBuZXcgVWludDE2QXJyYXkoMSArIDQpO1xuICAgIHBheWxvYWQuc2V0KG9wY29kZSwgMCk7XG4gICAgcGF5bG9hZC5zZXQobmV3IFVpbnQxNkFycmF5KGVuZFRpbWVCdWZmZXIuYnVmZmVyKSwgMSk7XG5cbiAgICByZXR1cm4gcGF5bG9hZC5idWZmZXI7XG4gIH0sXG4gIC8vIGBvcGNvZGVgICAgIDIgYnl0ZXMgKFVpbnQxNikgfFxuICAvLyBgdGltZWAgICAgICA4IGJ5dGVzIChGbG9hdDY0KSB8XG4gIC8vIGBkYXRhYCAgICAgIGZyYW1lU2l6ZSAqIDQgKEZsb2F0MzIpIHxcbiAgLy8gYG1ldGFkYXRhYCAgbiBieXRlcyAoVWludDE2KVxuICBwcm9jZXNzRnJhbWU6IGZ1bmN0aW9uKGZyYW1lLCBmcmFtZVNpemUpIHtcbiAgICBjb25zdCBvcGNvZGUgPSBlbmNvZGVycy5vcGNvZGUoJ1BST0NFU1NfRlJBTUUnKTtcblxuICAgIGNvbnN0IHRpbWUgPSBuZXcgRmxvYXQ2NEFycmF5KDEpO1xuICAgIHRpbWVbMF0gPSBmcmFtZS50aW1lO1xuXG4gICAgY29uc3QgZGF0YSA9IG5ldyBGbG9hdDMyQXJyYXkoZnJhbWVTaXplKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZyYW1lU2l6ZTsgaSsrKVxuICAgICAgZGF0YVtpXSA9IGZyYW1lLmRhdGFbaV07XG5cbiAgICBjb25zdCBtZXRhZGF0YSA9IGpzb24yVWludDE2QXJyYXkoZnJhbWUubWV0YWRhdGEpO1xuXG4gICAgY29uc3QgbGVuZ3RoID0gMSArIDQgKyAoMiAqIGZyYW1lU2l6ZSkgKyBtZXRhZGF0YS5sZW5ndGg7XG4gICAgY29uc3QgcGF5bG9hZCA9IG5ldyBVaW50MTZBcnJheShsZW5ndGgpO1xuICAgIHBheWxvYWQuc2V0KG9wY29kZSwgMCk7XG4gICAgcGF5bG9hZC5zZXQobmV3IFVpbnQxNkFycmF5KHRpbWUuYnVmZmVyKSwgMSk7XG4gICAgcGF5bG9hZC5zZXQobmV3IFVpbnQxNkFycmF5KGRhdGEuYnVmZmVyKSwgMSArIDQpO1xuICAgIHBheWxvYWQuc2V0KG1ldGFkYXRhLCAxICsgNCArICgyICogZnJhbWVTaXplKSk7XG5cbiAgICByZXR1cm4gcGF5bG9hZC5idWZmZXI7XG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IGRlY29kZXJzID0ge1xuICBvcGNvZGUoYXJyYXlCdWZmZXIpIHtcbiAgICByZXR1cm4gbmV3IFVpbnQxNkFycmF5KGFycmF5QnVmZmVyKVswXTtcbiAgfSxcbiAgLy8gYG9wY29kZWAgICAgMiBieXRlcyAoVWludDE2KSB8XG4gIC8vIGBzdHJlYW1QYXJhbXNgICBuIGJ5dGVzIChVaW50MTYpXG4gIHN0cmVhbVBhcmFtcyhhcnJheUJ1ZmZlcikge1xuICAgIGNvbnN0IHBheWxvYWQgPSBuZXcgVWludDE2QXJyYXkoYXJyYXlCdWZmZXIuc2xpY2UoMikpO1xuICAgIGNvbnN0IHByZXZTdHJlYW1QYXJhbXMgPSBVaW50MTZBcnJheTJqc29uKHBheWxvYWQpO1xuICAgIHJldHVybiBwcmV2U3RyZWFtUGFyYW1zO1xuICB9LFxuICAvLyBgb3Bjb2RlYCAgICAyIGJ5dGVzIChVaW50MTYpIHxcbiAgLy8gYGVuZFRpbWVgICAgOCBieXRlcyAoRmxvYXQ2NClcbiAgZmluYWxpemVTdHJlYW0oYXJyYXlCdWZmZXIpIHtcbiAgICByZXR1cm4gbmV3IEZsb2F0NjRBcnJheShhcnJheUJ1ZmZlci5zbGljZSgyKSlbMF07XG4gIH0sXG4gIC8vIGBvcGNvZGVgICAgIDIgYnl0ZXMgKFVpbnQxNikgfFxuICAvLyBgdGltZWAgICAgICA4IGJ5dGVzIChGbG9hdDY0KSB8XG4gIC8vIGBkYXRhYCAgICAgIGZyYW1lU2l6ZSAqIDQgKEZsb2F0MzIpIHxcbiAgLy8gYG1ldGFkYXRhYCAgbiBieXRlcyAoVWludDE2KVxuICBwcm9jZXNzRnJhbWUoYXJyYXlCdWZmZXIsIGZyYW1lU2l6ZSkge1xuICAgICAgLy8gMSAqIDggYnl0ZXNcbiAgICAgIGNvbnN0IHRpbWVTdGFydCA9IDI7XG4gICAgICBjb25zdCB0aW1lRW5kID0gdGltZVN0YXJ0ICsgODtcbiAgICAgIGNvbnN0IHRpbWUgPSBuZXcgRmxvYXQ2NEFycmF5KGFycmF5QnVmZmVyLnNsaWNlKHRpbWVTdGFydCwgdGltZUVuZCkpWzBdO1xuICAgICAgLy8gZnJhbWVTaXplICogNCBieXRlc1xuICAgICAgY29uc3QgZGF0YVN0YXJ0ID0gdGltZUVuZDtcbiAgICAgIGNvbnN0IGRhdGFFbmQgPSBkYXRhU3RhcnQgKyA0ICogZnJhbWVTaXplO1xuICAgICAgY29uc3QgZGF0YSA9IG5ldyBGbG9hdDMyQXJyYXkoYXJyYXlCdWZmZXIuc2xpY2UoZGF0YVN0YXJ0LCBkYXRhRW5kKSk7XG4gICAgICAvLyByZXN0IG9mIHBheWxvYWRcbiAgICAgIGNvbnN0IG1ldGFTdGFydCA9IGRhdGFFbmQ7XG4gICAgICBjb25zdCBtZXRhQnVmZmVyID0gbmV3IFVpbnQxNkFycmF5KGFycmF5QnVmZmVyLnNsaWNlKG1ldGFTdGFydCkpO1xuICAgICAgY29uc3QgbWV0YWRhdGEgPSBVaW50MTZBcnJheTJqc29uKG1ldGFCdWZmZXIpO1xuXG4gICAgICByZXR1cm4geyB0aW1lLCBkYXRhLCBtZXRhZGF0YSB9O1xuICB9XG59XG4iXX0=